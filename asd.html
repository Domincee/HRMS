<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HRMS Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet" />
  <link rel="stylesheet" href="/public/css/styles.css" />
</head>

<body>
  <!-- HEADER -->
  <header>
    <div class="head-box">
      <div class="logo-container" id="logoHolder">
        <p class="logo">HRMS</p>
      </div>
      <div class="account-container">
        <ul class="dropdown-container">
          <li id="toggleDropdown"><i class="ri-account-circle-fill"></i></li>
          <ul class="account-dropdown">
            <li class="bell-notif"><img src="/public/imgs-icons/notification.png" alt="Notification" /></li>
            <li class="mess-notif"><img src="/public/imgs-icons/message.png" alt="Messages" /></li>
            <li class="settings"><img src="/public/imgs-icons/setting.png" alt="Settings" /></li>
            <li class="sign-out"><img src="/public/imgs-icons/out.png" alt="Sign Out" /></li>
          </ul>
        </ul>
      </div>
    </div>
  </header>

  <!-- BOTTOM NAVIGATION -->
  <div class="bottom-box">
    <ul class="navigator-container">
      <li class="list-icon active" id="toggleDashboard"><i class="ri-dashboard-horizontal-line"></i></li>
      <li class="list-icon" id="toggleEmployee"><i class="ri-user-fill"></i></li>
      <li class="list-icon" id="toggleAttendance"><i class="ri-calendar-check-line"></i></li>
      <li class="list-icon" id="togglePerformance"><i class="ri-line-chart-fill"></i></li>
    </ul>

    <div class="quicManage">
      <ul class="quickManage-container">
        <li class="toggle-show"><img src="/public/imgs-icons/plus.png" alt="Show Manage"/></li>
        <ul class="manage-show">
          <li class="add-new"><img src="/public/imgs-icons/people.png" alt="Add Employee"/></li>
          <li class="edit-employee"><img src="/public/imgs-icons/edit.png" alt="Edit"/></li>
          <li class="new-message"><img src="/public/imgs-icons/conversation.png" alt="Message"/></li>
        </ul>
      </ul>
    </div>
  </div>

  <!-- DASHBOARD -->
  <section class="dashboard-section" id="dashboard">
    <h1>Dashboard</h1>
    <div class="container-1">
      <div class="card">
        <span>Employees</span>
        <div class="count">
          <strong>Total:</strong> <span id="totalEmployee">0</span> <i class="ri-user-fill"></i>
        </div>
      </div>
      <div class="card card1">
        <span>New Employees</span>
        <div class="count">
          <strong>Total:</strong> <span id="newEmpTotal">0</span> <i class="ri-user-fill"></i>
        </div>
      </div>
      <div class="card card2">
        <p>On Leave</p>
        <div class="count">
          <strong>Total:</strong> <span id="onLeaveTotal">0</span> <i class="ri-user-fill"></i>
        </div>
      </div>
      <div class="card card3">
        <p>Manage <br /> Employee</p>
        <div class="btns">
          <button class="add-new">Add</button>
          <button class="edit-employee">Edit</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SEARCH AND FILTER -->
  <div class="top-container">
    <div class="search-container">
      <label for="searchInput">Search:</label>
      <input class="searchbar" type="text" id="searchInput" placeholder="Search..."/>
    </div>
    <div class="filter-container">
      <select id="departmentFilter" size="1">
        <option value="All">All</option>
      </select>
    </div>
  </div>

  <!-- TABLE CONTAINER (REQUIRED BY SCRIPT) -->
  <main>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>First Name</th><th>Last Name</th><th>Age</th><th>Department</th><th>Date Hired</th><th>Active</th>
        </tr>
      </thead>
      <tbody id="employeeTableBody"></tbody>
    </table>
    <div id="chart" style="height: 200px; display: flex; gap: 5px;"></div>
  </main>

  <!-- MODULE SCRIPT -->
  <script type="module">
    import { saveEmployees, loadEmployees } from '/public/js/storage.js';
    import { employeesFromRecord } from '/public/js/record.js';

    let employees = loadEmployees() || [...employeesFromRecord];
    const tableBody = document.getElementById("employeeTableBody");
    const departmentFilter = document.getElementById("departmentFilter");
    const chart = document.getElementById("chart");

    function populateDepartmentFilter() {
      const uniqueDepartments = new Set(employees.map(emp => emp.department.trim()));
      departmentFilter.innerHTML = `<option value="All">All</option>`;
      uniqueDepartments.forEach(dept => {
        const option = document.createElement("option");
        option.value = dept;
        option.textContent = dept;
        departmentFilter.appendChild(option);
      });
    }

    function renderTable(data) {
      tableBody.innerHTML = "";
      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No employees found.</td></tr>`;
        return;
      }
      data.forEach(emp => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${emp.id}</td>
          <td>${emp.firstName}</td>
          <td>${emp.lastName}</td>
          <td>${emp.age}</td>
          <td>${emp.department}</td>
          <td>${emp.dateHired}</td>
          <td>${emp.active ? "Yes" : "No"}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function renderChart(data) {
      chart.innerHTML = "";
      const departmentCounts = {};
      data.forEach(emp => {
        const dept = emp.department.trim();
        departmentCounts[dept] = (departmentCounts[dept] || 0) + 1;
      });

      
      const sortedDepartments = Object.entries(departmentCounts).sort((a, b) => a[1] - b[1]);
      const maxCount = Math.max(...Object.values(departmentCounts));

      sortedDepartments.forEach(([dept, count]) => {
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.height = `${(count / maxCount) * 100}%`;
        if (count === maxCount) bar.classList.add("highlight");

        const value = document.createElement("div");
        value.className = "bar-value";
        value.textContent = count;
        bar.appendChild(value);

        const label = document.createElement("div");
        label.className = "bar-label";
        label.textContent = dept;
        bar.appendChild(label);

        chart.appendChild(bar);
      });
    }

            function updateDashboardCounts(data) {
        document.getElementById("totalEmployee").textContent = data.length;

        // Count new employees hired this month
        const thisMonth = new Date().getMonth();
        const thisYear = new Date().getFullYear();

        const newEmployees = data.filter(emp => {
            const hireDate = new Date(emp.dateHired);
            return hireDate.getMonth() === thisMonth && hireDate.getFullYear() === thisYear;
        });

        document.getElementById("newEmpTotal").textContent = newEmployees.length;
        }


    departmentFilter.addEventListener("change", () => {
      const selected = departmentFilter.value;
      const filtered = selected === "All"
        ? employees
        : employees.filter(emp => emp.department.trim() === selected);
      renderTable(filtered);
      renderChart(filtered);
    });

    const searchInput = document.getElementById("searchInput");
    searchInput.addEventListener("input", () => {
      const query = searchInput.value.trim().toLowerCase();
      const filtered = employees.filter(emp =>
        emp.firstName.toLowerCase().startsWith(query) ||
        emp.lastName.toLowerCase().startsWith(query) ||
        emp.department.toLowerCase().startsWith(query)
      );
      renderTable(filtered);
      renderChart(filtered);
    });

    populateDepartmentFilter();
    renderTable(employees);
    renderChart(employees);
    updateDashboardCounts(employees); 
  </script>
</body>
</html>
